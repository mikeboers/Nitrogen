#!/usr/bin/env python2.6
# encoding: utf8

"""USAGE: %s path

Script for discovering and running all of the tests in a given package.

Imports all of the modules that are accessable, and looks for anything that
could be a test:
    - doctests
    - unittest classes
    - functions whose name matches test* (ie. nose tests)

Requirements:
    - nose
    
"""


import os
import sys
import unittest
import doctest
import logging
import traceback


usage = __doc__.rstrip() % sys.argv[0]

if len(sys.argv) < 2:
    print usage
    exit(1)

root = os.path.abspath(sys.argv[1])

root_dir = os.path.dirname(root)
root_name = os.path.basename(root)

print 'Finding tests in %r package rooted at %r.' % (root_name, root_dir)

logging.basicConfig(level=logging.INFO)

# Turn off nose logging.
logger = logging.getLogger('nose')
logger.setLevel(1000)

try:
    import nose.loader
    nose_loader = nose.loader.TestLoader()
except ImportError:
    nose_loader = None
    print 'ERROR: could not import nose'
    print usage
    exit(1)

sys.path.append(os.path.dirname(root))
suites = []

# Searching for paths...
for dirpath, dirnames, filenames in os.walk(root):
    for name in filenames:
        if name.endswith('.py'):
            
            doc_suite = None
            nose_suite = None
            
            path = os.path.join(dirpath, name)
            
            
            # Turn it into a module
            name = path[len(root_dir) + 1:-3].replace(os.path.sep, '.')
            if name.endswith('.__init__'):
                name = name[:-len('.__init__')]
            
            # Skip the library or "binaries".
            if '.lib.' in name or '.bin.' in name:
                continue
                
            # Make sure we can even get to it.
            if not os.path.exists(os.path.join(os.path.dirname(path), '__init__.py')):
                # print '\t%s is unreachable' % name
                continue
            
            try:
                m = __import__(name, fromlist=['force']) # Needs something in fromlist.
                
            except Exception as e:
                tb = ''.join(traceback.format_exception(*sys.exc_info())).strip()
                tb = tb.replace('\n', '\n\t\t')
                print '\t%s:' % name, 'exception while importing: ' + tb
            
            else:
                
                # Nose and unit tests
                if nose_loader:
                    nose_suite = nose_loader.loadTestsFromModule(m)
                
                # Doc tests
                try:
                    doc_suite = doctest.DocTestSuite(m)
                except ValueError as e:
                    if len(e.args) <= 1 or e.args[1] != 'has no tests':
                        raise
                
            nose_count = len(list(nose_suite._get_tests())) if nose_suite else 0
            if nose_count:
                suites.append(nose_suite)
                # print "\t\tFound %d nose/unittest test%s." % (nose_count, 's' if nose_count > 1 else '')
                
            
            doc_count = doc_suite.countTestCases() if doc_suite else 0
            if doc_count:
                suites.append(doc_suite)
                # print "\t\tFound %d doc test%s." % (doc_count, 's' if doc_count > 1 else '')
            
            if not (nose_count or doc_count):
                # print '\t%s has no tests' % name
                pass
                
            
        elif name.endswith('.doctest'):
            path = dirpath + '/' + name
            suite = doctest.DocFileSuite(path, module_relative=False, encoding='UTF-8')
            suites.append(suite)

# Nesseary to flush output before running tests on Windows.
sys.stderr.flush()
sys.stdout.flush()

runner = unittest.TextTestRunner()
suite = unittest.TestSuite()
suite.addTests(suites)
runner.run(suite)